Guessing Compressed Font ROM Format

Physical font ROM 128KiB is mapped to 256KiB address space
(80000h-bffffh), including gaiji 2KiB SRAM.  Technical Reference says
that the ROM is compressed by hardware.  Guessing the details of the
address translation from dumped 256KiB ROM image and checksum
calculation algorithm.

For address range 80000h-87fffh:

     CPU A16  -----  ROM A16
     CPU A15  -----  ROM A15
     CPU A14  -----  ROM A14
     CPU A13  -----  ROM A13
     CPU A12  -----  ROM A12
     CPU A11  -----  ROM A11

For address range 90000h-bffffh:

 +-----------------  ROM A16
 | +---------------  ROM A15
 | | CPU A16  -----  ROM A14
 | | CPU A15  -----  ROM A13
 | | CPU A14  -----  ROM A12
 | | CPU A13  -----  ROM A11
 | | CPU A12  ----+
 | | CPU A11  --+ |
 | +------------+ |
 +--------------- +


Reading Hankaku Font Example

uint8_t code = 0x??; // 8bit character code
uint32_t addr = 0x80000 | ((uint32_t)code << 5);
uint8_t font8x16[16], font8x8jr[8], font8x8jx[8], i;
for (i = 0; i < 16; i++) font8x16[i]  = read_uint8 (addr | (i << 1));
for (i = 0; i < 8;  i++) font8x8jx[i] = read_uint8 (addr | (i << 1) | 0x01);
for (i = 0; i < 8;  i++) font8x8jr[i] = read_uint8 (addr | (i << 1) | 0x11);


Reading Zenkaku Font Example

uint16_t code = 0x????; // 16bit Shift_JIS (starting from 0x8140)
if (code >= 0x8440 && code <= 0x8460) // Russian code conversion
  code -= 0x340;
else if (code >= 0x8470 && code <= 0x8491)
  code -= 0x270;
else if (code >= 0xf040 && code <= 0xf07e) // Gaiji
  code -= 0x6c00;
uint32_t addr = 0x80000 | (((uint32_t)code & 0x1fff) << 5);
uint16_t font16x16[16], i;
for (i = 0; i < 16; i++) font16x16[i]  = read_uint16 (addr | (i << 1));


128KiB    256KiB   128KiB 256KiB
A16-11    A17-11   hex start addresses
000000 <= 0000000  00000  80000
000001 <= 0000001  00800  80800
000010 <= 0000010  01000  81000
000011 <= 0000011  01800  81800
000100 <= 0000100  02000  82000
000101 <= 0000101  02800  82800
000110 <= 0000110  03000  83000
000111 <= 0000111  03800  83800
001000 <= 0001000  04000  84000
001001 <= 0001001  04800  84800
001010 <= 0001010  05000  85000
001011 <= 0001011  05800  85800
001100 <= 0001100  06000  86000
001101 <= 0001101  06800  86800
001110 <= 0001110  07000  87000
001111 <= 0001111  07800  87800

Gaiji  <= 001xxxx  -----  88000

!@#$%^ <=  #$%^!@

000000 <= 1000000  00000  a0000
000001 <= 1000100  00800  a2000
000010 <= 1001000  01000  a4000
000011 <= 1001100  01800  a6000
000100 <= 1010000  02000  a8000
000101 <= 1010100  02800  aa000
000110 <= 1011000  03000  ac000
000111 <= 1011100  03800  ae000
001000 <= x100000  04000  90000 b0000
001001 <= x100100  04800  92000 b2000
001010 <= x101000  05000  94000 b4000
001011 <= x101100  05800  96000 b6000
001100 <= x110000  06000  98000 b8000
001101 <= x110100  06800  9a000 ba000
001110 <= x111000  07000  9c000 bc000
001111 <= x111100  07800  9e000 be000

010000 <= 1000001  08000  a0800
010001 <= 1000101  08800  a2800
010010 <= 1001001  09000  a4800
010011 <= 1001101  09800  a6800
010100 <= 1010001  0a000  a8800
010101 <= 1010101  0a800  aa800
010110 <= 1011001  0b000  ac800
010111 <= 1011101  0b800  ae800
011000 <= x100001  0c000  90800 b0800
011001 <= x100101  0c800  92800 b2800
011010 <= x101001  0d000  94800 b4800
011011 <= x101101  0d800  96800 b6800
011100 <= x110001  0e000  98800 b8800
011101 <= x110101  0e800  9a800 ba800
011110 <= x111001  0f000  9c800 bc800
011111 <= x111101  0f800  9e800 be800

100000 <= 1000010  10000  a1000
100001 <= 1000110  10800  a3000
100010 <= 1001010  11000  a5000
100011 <= 1001110  11800  a7000
100100 <= 1010010  12000  a9000
100101 <= 1010110  12800  ab000
100110 <= 1011010  13000  ad000
100111 <= 1011110  13800  af000
101000 <= x100010  14000  91000 b1000
101001 <= x100110  14800  93000 b3000
101010 <= x101010  15000  95000 b5000
101011 <= x101110  15800  97000 b7000
101100 <= x110010  16000  99000 b9000
101101 <= x110110  16800  9b000 bb000
101110 <= x111010  17000  9d000 bd000
101111 <= x111110  17800  9f000 bf000

110000 <= 1000011  18000  a1800
110001 <= 1000111  18800  a3800
110010 <= 1001011  19000  a5800
110011 <= 1001111  19800  a7800
110100 <= 1010011  1a000  a9800
110101 <= 1010111  1a800  ab800
110110 <= 1011011  1b000  ad800
110111 <= 1011111  1b800  af800
111000 <= x100011  1c000  91800 b1800
111001 <= x100111  1c800  93800 b3800
111010 <= x101011  1d000  95800 b5800
111011 <= x101111  1d800  97800 b7800
111100 <= x110011  1e000  99800 b9800
111101 <= x110111  1e800  9b800 bb800
111110 <= x111011  1f000  9d800 bd800
111111 <= x111111  1f800  9f800 bf800
